<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>مستخلص توريدات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      :root {
        --dark: #083448;
        --gold: #c9a24d;
        --dark-blue: #083448;
      }

      body {
        font-family: "Cairo", sans-serif;
        background: #f4f4f4;
      }

      /* تعديل هام لضمان عدم قص المحتوى */
      .printable {
        width: 100%;
        /* تقييد العرض ليطابق A4 تماماً */
        max-width: 195mm !important;
        min-width: 195mm !important;
        margin: 0 auto;
        background: white;
        /* إخفاء أي زحائد خارجية */
        overflow-x: hidden;
      }

      p,
      h1 {
        color: var(--dark-blue);
      }

      @media print {
        body {
          background: white !important;
        }
        .no-print {
          display: none !important;
        }
        * {
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        @page {
          size: A4;
          margin: 0; /* إلغاء هوامش المتصفح الافتراضية للتحكم الكامل */
        }

        table {
          width: 100% !important;
          table-layout: fixed !important;
          margin: 0 auto !important;
          direction: rtl !important;
        }

        th,
        td {
          text-align: center !important;
          vertical-align: middle !important;
          padding: 2px !important;
          font-size: 10px !important;
        }

        thead {
          display: table-header-group;
        }

        tr {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>

  <body class="p-4">
    <div class="no-print bg-white border border-gray-300 rounded-xl p-4">
      <h3 class="text-base font-bold text-[var(--dark)] border-b pb-2 mb-3">
        إضافة بيانات المستخلص
      </h3>

      <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-xs font-semibold mb-1">التاريخ</label>
          <input
            id="date"
            type="date"
            class="w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--dark-blue)]"
          />
        </div>
      </div>

      <div class="mb-3">
        <label class="block text-xs font-semibold mb-1">المكان</label>
        <input
          id="location"
          type="text"
          placeholder="المنطقة والحي والمدينة"
          class="w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--dark-blue)]"
        />
      </div>

      <div class="mb-3">
        <label class="block text-xs font-semibold mb-1">عنوان المستخلص</label>
        <input
          id="extractTitle"
          type="text"
          placeholder="مستخلص قطعة 51..."
          class="w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--dark-blue)]"
        />
      </div>

      <div class="flex gap-2">
        <!-- onclick="addSupplyRow()" -->
        <button
          id="addSupplyRowBtn"
          class="flex-1 bg-green-600 text-white py-2 rounded text-sm font-bold"
        >
          + إضافة صف توريدات
        </button>
        <button
          id="removeRowBtn"
          class="flex-1 bg-red-700 text-white py-2 rounded text-sm font-bold"
        >
          حذف صفوف
        </button>
      </div>

      <div class="flex gap-2 mt-2">
        <!-- onclick="toggleSupplySupervision()" -->
        <button
          id="supplySupervisionBtn"
          class="flex-1 bg-green-800 text-white py-2 rounded text-sm font-bold"
        >
          + إضافة نسبة إشراف (توريدات)
        </button>
      </div>

      <div class="flex gap-2 mt-3 pt-3 border-t border-gray-300">
        <button
          onclick="window.print()"
          class="flex-1 bg-[var(--dark)] text-white py-2 rounded text-sm font-bold"
        >
          طباعة المستخلص
        </button>

        <button
          onclick="downloadPDF()"
          class="flex-1 bg-red-700 text-white py-2 rounded text-sm font-bold"
        >
          تحميل PDF
        </button>
      </div>
    </div>
    <div class="max-w-7xl mt-4 mx-auto space-y-4 printable">
      <!-- التحكم (لا يطبع) -->

      <!-- المستند -->
      <div class="bg-white border border-gray-300 rounded-xl overflow-hidden">
        <!-- Header -->
        <div class="border-b p-3">
          <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
              <div
                class="w-16 h-16 border flex items-center justify-center overflow-hidden"
              >
                <img
                  src="./logo.jpg"
                  class="w-20 h-20 object-cover"
                  alt="Logo"
                />
              </div>
              <div>
                <h1 class="text-lg font-extrabold text-[var(--dark)]">
                  AMAIR REAL ESTATE DEVELOPMENT
                </h1>
              </div>
            </div>
          </div>

          <div class="space-y-2 mt-2 text-xs">
            <p class="font-semibold">
              التاريخ: <span id="displayDate">--/--/----</span>
            </p>
            <div class="w-full space-y-2">
              <p class="font-bold flex-1">
                المكان: <span id="displayLocation"></span>
              </p>
              <p
                class="mt-4 font-bold text-center flex-1 text-[var(--dark)]"
                id="displayExtractTitle"
              ></p>
            </div>
          </div>
        </div>

        <!-- المحتوى -->
        <div class="p-3 space-y-4 text-xs">
          <!-- جدول التوريدات -->
          <div>
            <div class="font-bold flex items-center p-2">
              <p class="ml-2">اسم المشروع</p>
              <p
                contenteditable="true"
                class="outline-none bg-gray-200 min-w-20"
              ></p>
            </div>
            <div class="font-bold flex items-center p-2">
              <p class="ml-2">اسم المورّد</p>
              <p
                contenteditable="true"
                class="outline-none bg-gray-200 min-w-20"
              ></p>
            </div>
            <div class="font-bold flex items-center p-2">
              <p class="ml-2">رقم التليفون</p>
              <p
                contenteditable="true"
                class="outline-none bg-gray-200 min-w-20"
              ></p>
            </div>
            <h3 class="font-bold text-[var(--dark)] mb-2 text-center text-sm">
              مستخلص ( توريدات )
            </h3>
            <table class="w-full text-center text-xs">
              <thead class="bg-[var(--dark-blue)]">
                <tr>
                  <th class="border border-white text-white p-1.5 w-8">م</th>
                  <th class="border border-white text-white p-1.5">البند</th>
                  <th class="border border-white text-white p-1.5 w-16">
                    الكمية
                  </th>
                  <th class="border border-white text-white p-1.5 w-16">
                    الوحدة
                  </th>
                  <th class="border border-white text-white p-1.5 w-16">
                    السعر
                  </th>
                  <th class="border border-white text-white p-1.5 w-16">
                    الإجمالي
                  </th>
                  <th class="border border-white text-white p-1.5">ملحوظات</th>
                </tr>
              </thead>
              <tbody id="suppliesBody">
                <tr>
                  <td class="border border-gray-300 p-1">1</td>
                  <td class="border border-gray-300 p-1" contenteditable="true">
                    -
                  </td>
                  <td class="border border-gray-300 p-1" contenteditable="true">
                    0
                  </td>
                  <td class="border border-gray-300 p-1" contenteditable="true">
                    -
                  </td>
                  <td class="border border-gray-300 p-1" contenteditable="true">
                    0
                  </td>
                  <td
                    class="border border-gray-300 p-1 font-semibold"
                  >
                    0
                  </td>
                  <td
                    contenteditable="true"
                    class="border border-gray-300 p-1 font-semibold"
                  >
                    -
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="bg-[var(--dark-blue)] text-white">
                  <td
                    colspan="2"
                    class="border border-white p-2 font-bold text-right"
                  >
                    الإجمالي
                  </td>
                  <td
                    colspan="5"
                    class="border border-white p-2 font-bold"
                    id="suppliesTotal"
                  >
                    0
                  </td>
                </tr>
                <tr class="bg-gray-100">
                  <td
                    colspan="2"
                    class="border border-white p-2 font-bold text-right"
                  >
                    المدفوع
                  </td>
                  <td
                    colspan="5"
                    class="border border-white p-2 font-bold"
                    id="suppliesPayed"
                    contenteditable="true"
                  >
                    0
                  </td>
                </tr>
                <tr class="bg-[var(--dark-blue)] text-white">
                  <td
                    colspan="2"
                    class="border border-white p-2 font-bold text-right"
                  >
                    المتبقي
                  </td>
                  <td
                    colspan="5"
                    class="border border-white p-2 font-bold"
                    id="suppliesRemaining"
                  >
                    0
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- الملخص النهائي -->
          <div class="border-t border-gray-300 pt-2">
            <div
              class="grid grid-cols-2 gap-3 text-sm font-bold max-w-md mx-auto"
            >
              <div class="text-right">
                <p class="mb-1">اجمالي التوريدات</p>
              </div>
              <div class="text-left">
                <p class="mb-1" id="summarySupplies">0</p>
              </div>

              <!-- <div class="text-right">
                <p class="mb-1">الإجمالى</p>
              </div>
              <div class="text-left">
                <p class="mb-1" id="grandTotal">0</p>
              </div> -->
            </div>
          </div>

          <!-- التوقيعات -->
          <div class="grid grid-cols-3 gap-4 pt-0 border-t">
            <div class="text-center">
              <div class="border-b border-gray-400 pb-10 mt-6">
                <p class="font-semibold text-xs">توقيع المقاول</p>
              </div>
            </div>
            <div class="text-center">
              <div class="border-b border-gray-400 pb-10 mt-6">
                <p class="font-semibold text-xs">توقيع م. الحسابات</p>
              </div>
            </div>
            <div class="text-center">
              <div class="border-b border-gray-400 pb-10 mt-6">
                <p class="font-semibold text-xs">توقيع رئيس مجلس الإدارة</p>
              </div>
            </div>
          </div>

          <!-- معلومات التواصل -->
          <div
            dir="ltr"
            class="text-start mt-4 pt-3 border-t text-xs space-y-0.5"
          >
            <p class="font-bold text-[var(--dark)]">CONTACTS:</p>
            <p>INSTAGRAM: Amairgeneralcontracting | FACEBOOK: AMAIR</p>
            <p>SITE: Amaireg.com | CALL US: 01060 23 8888</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const supplySupervisionBtn = document.getElementById(
          "supplySupervisionBtn"
        );

        const addSupplyRowBtn = document.getElementById("addSupplyRowBtn");

        const removeRowBtn = document.getElementById("removeRowBtn");

        let isRemoving = false;
        /* Remove Rows */
        removeRowBtn.addEventListener("click", function (e) {
          const tbody = document.getElementById("suppliesBody");
          const normalRowsCount = tbody.querySelectorAll(
            "tr:not([data-supervision])"
          ).length;

          // التحقق من وجود أكثر من صف واحد
          if (normalRowsCount <= 1 && !isRemoving) {
            alert("يجب إضافة صفوف أولاً");
            return;
          }

          if (!isRemoving) {
            isRemoving = true;
            removeRowBtn.classList.remove("bg-red-700");
            removeRowBtn.classList.add("bg-red-500");
            removeRowBtn.textContent = "اضغط على الصفوف لحذفها";

            // إضافة مستمعات الحذف لكل الصفوف
            const rows = document.querySelectorAll(
              "#suppliesBody tr:not([data-supervision])"
            );
            rows.forEach((row) => {
              row.style.cursor = "pointer";
              row.classList.add("delete-mode", "hover:bg-red-200");
              row.addEventListener("click", deleteRowHandler);
            });
          } else {
            isRemoving = false;
            removeRowBtn.classList.remove("bg-red-500");
            removeRowBtn.classList.add("bg-red-700");
            removeRowBtn.textContent = "حذف صفوف";

            // إزالة مستمعات الحذف
            const rows = document.querySelectorAll("#suppliesBody tr");
            rows.forEach((row) => {
              row.style.cursor = "default";
              row.classList.remove("delete-mode", "hover:bg-red-200");
              row.removeEventListener("click", deleteRowHandler);
            });
          }
        });

        function deleteRowHandler(e) {
          if (!isRemoving) return;

          const row = e.currentTarget;
          const tbody = document.getElementById("suppliesBody");

          // التأكد من وجود صف واحد على الأقل
          if (
            tbody.querySelectorAll("tr:not([data-supervision])").length <= 1
          ) {
            alert("يجب الاحتفاظ بصف واحد على الأقل");
            return;
          }

          row.remove();

          // إعادة ترقيم الصفوف
          const normalRows = tbody.querySelectorAll(
            "tr:not([data-supervision])"
          );
          normalRows.forEach((r, index) => {
            r.cells[0].textContent = index + 1;
          });

          supplyRowCount = normalRows.length;
          calculateTotals();
        }

        // /* ========= DATE ========= */
        // const dateInput = document.getElementById("date");
        // const displayDate = document.getElementById("displayDate");

        // if (dateInput) {
        //   dateInput.addEventListener("change", function (e) {
        //     if (e.target.value) {
        //       const d = new Date(e.target.value);
        //       displayDate.textContent = d.toLocaleDateString("ar-EG");
        //     } else {
        //       displayDate.textContent = "--/--/----";
        //     }
        //   });
        // }
        /* ========= DATE ========= */
        const dateInput = document.getElementById("date");
        const displayDate = document.getElementById("displayDate");

        if (dateInput) {
          dateInput.addEventListener("change", function (e) {
            if (e.target.value) {
              const d = new Date(e.target.value);

              const numericDate = d.toLocaleDateString("ar-EG", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
              });

              const monthName = d.toLocaleDateString("ar-EG", {
                month: "long",
              });

              displayDate.textContent = `${numericDate} (${monthName})`;
            } else {
              displayDate.textContent = "--/--/----";
            }
          });
        }

        /* ========= LOCATION ========= */
        const locationInput = document.getElementById("location");
        const displayLocation = document.getElementById("displayLocation");

        if (locationInput) {
          locationInput.addEventListener("input", function (e) {
            displayLocation.textContent = e.target.value.trim() || "";
          });
        }

        /* ========= EXTRACT TITLE ========= */
        const extractTitleInput = document.getElementById("extractTitle");
        const displayExtractTitle = document.getElementById(
          "displayExtractTitle"
        );

        if (extractTitleInput) {
          extractTitleInput.addEventListener("input", function (e) {
            displayExtractTitle.textContent = e.target.value.trim() || "";
          });
        }

        let supplyRowCount = 1;

        function formatNumber(num) {
          return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        /* ===================== ADD ROWS ===================== */

        function addSupplyRow() {
          supplyRowCount++;
          const tbody = document.getElementById("suppliesBody");
          const row = document.createElement("tr");

          row.innerHTML = `
          <td class="border p-1">${supplyRowCount}</td>
          <td class="border p-1" contenteditable="true">-</td>
          <td class="border p-1" contenteditable="true">0</td>
          <td class="border p-1" contenteditable="true">-</td>
          <td class="border p-1" contenteditable="true">0</td>
          <td class="border p-1 bg-gray-50 font-semibold">0</td>
          <td class="border p-1" contenteditable="true">-</td>
        `;

          const supervision = tbody.querySelector(
            '[data-supervision="supply"]'
          );
          supervision
            ? tbody.insertBefore(row, supervision)
            : tbody.appendChild(row);

          attachEvents(row);
          calculateTotals();
        }
        addSupplyRowBtn.addEventListener("click", addSupplyRow);

        /* ===================== SUPERVISION ===================== */
        function toggleSupplySupervision() {
          const tbody = document.getElementById("suppliesBody");
          const existing = tbody.querySelector('[data-supervision="supply"]');

          if (existing) {
            existing.remove();
          } else {
            const row = document.createElement("tr");
            row.dataset.supervision = "supply";
            row.classList.add("bg-gray-100");

            row.innerHTML = `
            <td class="border p-1">-</td>
            <td class="border p-1 font-bold">نسبة الإشراف</td>
            <td class="border p-1 text-center" contenteditable="true">3</td>
            <td class="border p-1 text-center font-bold">%</td>
            <td class="border p-1 bg-gray-100 font-semibold">0</td>
            <td class="border p-1 bg-gray-100 font-semibold">0</td>
            <td class="border p-1">-</td>
          `;

            tbody.appendChild(row);
            attachEvents(row);
          }

          calculateTotals();
        }
        supplySupervisionBtn.addEventListener("click", toggleSupplySupervision);

        /* ===================== CALCULATION ===================== */

        function calculateRow(row) {
          const qty = parseFloat(row.cells[2].textContent) || 0;
          const price = parseFloat(row.cells[4].textContent) || 0;
          const total = qty * price;

          row.cells[5].textContent = formatNumber(total);
          return total;
        }

        function calculateTotals() {
          let suppliesTotal = 0;

          // ---- SUPPLIES ----
          const supplyRows = document.querySelectorAll(
            "#suppliesBody tr:not([data-supervision])"
          );

          supplyRows.forEach((row) => {
            suppliesTotal += calculateRow(row);
          });

          const supplySupervision = document.querySelector(
            '#suppliesBody [data-supervision="supply"]'
          );

          if (supplySupervision) {
            const percent =
              parseFloat(supplySupervision.cells[2].textContent) || 0;

            const supervisionValue = suppliesTotal * (percent / 100);

            supplySupervision.cells[4].textContent =
              formatNumber(suppliesTotal);

            supplySupervision.cells[5].textContent =
              formatNumber(supervisionValue);

            suppliesTotal += supervisionValue;
          }

          // ---- TOTALS ----
          document.getElementById("suppliesTotal").textContent =
            formatNumber(suppliesTotal);

          // const grandTotal = suppliesTotal;

          // document.getElementById("grandTotal").textContent =
          //   formatNumber(grandTotal);

          document.getElementById("summarySupplies").textContent =
            formatNumber(suppliesTotal);
        }

        /* ===================== EVENTS ===================== */

        function attachEvents(row) {
          row.querySelectorAll('[contenteditable="true"]').forEach((cell) => {
            cell.addEventListener("input", () => {
              calculateTotals();
              calculateRemaining(
                "suppliesTotal",
                "suppliesPayed",
                "suppliesRemaining"
              );
            });
            cell.addEventListener("blur", () => {
              calculateTotals();
              calculateRemaining(
                "suppliesTotal",
                "suppliesPayed",
                "suppliesRemaining"
              );
            });
          });
        }

        function calculateRemaining(totalId, payedId, remainingId) {
          const total =
            parseFloat(
              document.getElementById(totalId)?.textContent.replace(/,/g, "")
            ) || 0;

          const payed =
            parseFloat(
              document.getElementById(payedId)?.textContent.replace(/,/g, "")
            ) || 0;

          const remaining = total - payed;

          document.getElementById(remainingId).textContent = formatNumber(
            remaining < 0 ? 0 : remaining
          );
        }
        calculateRemaining(
          "suppliesTotal",
          "suppliesPayed",
          "suppliesRemaining"
        );

        document
          .querySelectorAll('[contenteditable="true"]')
          .forEach((cell) => attachEvents(cell.parentElement));

        calculateTotals();
      });

      // function downloadPDF() {
      //   // تحديد العنصر المراد تحويله
      //   const element = document.querySelector(".printable");

      //   // زر التحميل
      //   const btn = document.querySelector('button[onclick="downloadPDF()"]');
      //   const originalContent = btn.innerHTML;
      //   // تغيير حالة الزر
      //   btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> جاري التحميل...`;
      //   btn.disabled = true;

      //   // إعدادات التحويل
      //   const opt = {
      //     margin: [0.1, 0, 0.1, 0], // هوامش: علوي، أيمن، سفلي، أيسر (بالبوصة)
      //     filename:
      //       "مستخلص_" + document.getElementById("extractTitle").value ||
      //       "contractor_abstract" + ".pdf",
      //     image: { type: "jpeg", quality: 0.98 },
      //     html2canvas: {
      //       scale: 2, // زيادة الدقة
      //       useCORS: true, // للسماح بتحميل الصور من نطاقات أخرى
      //       logging: false,
      //       scrollY: 0,
      //     },
      //     jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
      //   };

      //   // التنفيذ
      //   html2pdf()
      //     .set(opt)
      //     .from(element)
      //     .save()
      //     .then(() => {
      //       // استعادة الزر بعد الانتهاء
      //       btn.innerHTML = originalContent;
      //       btn.disabled = false;
      //     })
      //     .catch((err) => {
      //       console.error(err);
      //       alert("حدث خطأ أثناء إنشاء ملف PDF");
      //       btn.innerHTML = originalContent;
      //       btn.disabled = false;
      //     });
      // }
      function downloadPDF() {
        // تحديد العنصر المراد تحويله
        const element = document.querySelector(".printable");

        // زر التحميل
        const btn = document.querySelector('button[onclick="downloadPDF()"]');
        const originalContent = btn.innerHTML;

        // تغيير حالة الزر
        btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="https://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> جاري التحميل...`;
        btn.disabled = true;

        // إعدادات التحويل
        const opt = {
          margin: [0.1, 0.2, 0.1, 0.2], // هوامش بسيطة (علوي، يمين، سفلي، يسار)
          filename:
            "مستخلص_" +
            (document.getElementById("extractTitle").value ||
              "contractor_abstract") +
            ".pdf",

          image: { type: "jpeg", quality: 0.98 },

          html2canvas: {
            scale: 2,
            useCORS: true,
            logging: false,
            scrollY: 0,
            // ===== الحل السحري هنا =====
            onclone: function (clonedDoc) {
              // البحث عن جميع العناصر القابلة للتعديل في النسخة المؤقتة
              const editables = clonedDoc.querySelectorAll(
                '[contenteditable="true"]'
              );

              editables.forEach(function (el) {
                // 1. إجبار الخط ليكون نفس خط الصفحة (Cairo)
                el.style.fontFamily = "'Cairo', sans-serif";

                // 2. التأكد من الاتجاه من اليمين لليسار
                el.style.direction = "rtl";

                // 3. إصلاح تداخل الحروف
                el.style.letterSpacing = "normal";

                // 4. حيلة: إزالة خاصية التعديل مؤقتاً لتصبح نص ثابت
                // هذا يجعل المتصفح يرسم الحروف العربية بشكل صحيح تماماً مثل العناوين
                el.removeAttribute("contenteditable");
              });
            },
          },

          jsPDF: { unit: "in", format: "a4", orientation: "portrait" },
        };

        // التنفيذ
        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
          })
          .catch((err) => {
            console.error(err);
            alert("حدث خطأ أثناء إنشاء ملف PDF");
            btn.innerHTML = originalContent;
            btn.disabled = false;
          });
      }
    </script>
  </body>
</html>
